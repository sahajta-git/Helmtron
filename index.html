import React, { useEffect, useState } from "react";

// ✅ Sensor data type
interface SensorData {
  mq135: number | null;
  mq5: number | null;
  hr: number | null;
  spo2: number | null;
  temp: number | null;
  hum: number | null;
  mpu: number | null;
}

// ✅ ThingSpeak Channel
const CHANNEL_ID = 3138290;
const POLL_INTERVAL = 7000;

const FIELD_MAP = {
  mq135: "field1",
  mq5: "field2",
  hr: "field3",
  spo2: "field4",
  temp: "field5",
  hum: "field6",
  mpu: "field7",
};

const LABELS: Record<string, { label: string; unit: string; limit: number }> = {
  mq135: { label: "Air Quality (MQ135)", unit: "PPM", limit: 300 },
  mq5: { label: "Gas (MQ5)", unit: "PPM", limit: 200 },
  hr: { label: "Heart Rate", unit: "BPM", limit: 120 },
  spo2: { label: "SpO2", unit: "%", limit: 90 },
  temp: { label: "Temperature", unit: "°C", limit: 40 },
  hum: { label: "Humidity", unit: "%", limit: 80 },
  mpu: { label: "Impact (MPU)", unit: "g", limit: 2000 },
};

export default function App() {
  const [data, setData] = useState<SensorData | null>(null);
  const [alert, setAlert] = useState<string>("");

  const fetchData = async () => {
    try {
      const res = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=1`);
      const json = await res.json();
      const feed = json.feeds[0];

      const parsed: any = {};
      Object.keys(FIELD_MAP).forEach((key) => {
        const field = FIELD_MAP[key as keyof typeof FIELD_MAP];
        parsed[key] = feed[field] ? Number(feed[field]) : null;
      });

      setData(parsed);

      const bad = Object.keys(parsed).filter((k) => parsed[k] !== null && parsed[k] > LABELS[k].limit);
      setAlert(bad.length ? `⚠️ Danger Detected: ${bad.map((b) => LABELS[b].label).join(", ")}` : "✅ Safe Environment");
    } catch {
      setAlert("❌ Error fetching data");
    }
  };

  useEffect(() => {
    fetchData();
    const interval = setInterval(fetchData, POLL_INTERVAL);
    return () => clearInterval(interval);
  }, []);

  return (
    <div style={{ background: "#0b1a2b", color: "#f1c40f", minHeight: "100vh", fontFamily: "Arial", paddingBottom: 40 }}>
      <header style={{ textAlign: "center", padding: 20, borderBottom: "3px solid #f1c40f" }}>
        <h1 style={{ fontSize: "2.5rem", margin: 0 }}>Helmtron</h1>
        <p>Smart IoT Safety Helmet</p>
      </header>

      <div style={{ textAlign: "center", padding: "20px", fontSize: "1.2rem", background: "#1b2f4b", margin: 20, borderRadius: 10 }}>
        {alert}
      </div>

      <div style={{ width: "90%", margin: "auto", maxWidth: 700 }}>
        {data &&
          Object.keys(data).map((k) => {
            const v = data[k as keyof SensorData];
            const info = LABELS[k];
            const danger = v !== null && v > info.limit;
            return (
              <div
                key={k}
                style={{
                  background: "#1b2f4b",
                  border: `2px solid ${danger ? "red" : "#f1c40f"}`,
                  padding: 15,
                  borderRadius: 10,
                  marginBottom: 15,
                }}
              >
                <h3>{info.label}</h3>
                <strong style={{ color: danger ? "red" : "#f1c40f" }}>
                  {v !== null ? `${v} ${info.unit}` : "--"}
                </strong>
                <p>{danger ? "⚠️ Harmful" : "✅ Safe"}</p>
              </div>
            );
          })}
      </div>

      <footer style={{ textAlign: "center", padding: 20, borderTop: "2px solid #f1c40f" }}>
        Made by Team Helmtron | NIIT University
      </footer>
    </div>
  );
}
